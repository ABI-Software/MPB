<!DOCTYPE html>
<html lang="en" style="height:100%">
	<head>
		<title>Myocardium WebGL Demo</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>			
			body {
				font-family: Monospace;
				background-color: #000;
				color: #fff;
				margin: 0px;
				overflow: hidden;
			}
			#info {
				color: #fff;
				position: absolute;
				top: 10px;
				width: 100%;
				text-align: center;
				z-index: 100;
				display:block;
			}
			#info a, .button { color: #f00; font-weight: bold; text-decoration: underline; cursor: pointer }			
		</style>
		<link rel="stylesheet" href="styles/my_styles.css">
		<link rel="stylesheet" href="styles/bootstrap.min.css">
		<script>
	    	var dojoConfig = {
				async: true,
				// This code registers the correct location of the "demo" package
				// so we can load Dojo from the CDN whilst still being able to
				// load local modules
				packages: [{
					name: "js",
					location: location.pathname.replace(/\/[^/]+$/, '')  + '/js'
				}]
			};
    	</script>
	</head>

	<body style="height:100%;" id="mainBody">
		<div style="position:absolute;height:100%;width:100%">
				
			<div id="tooltipcontainer">
				<div class="tooltip" id="tip">
	  				<span class="tooltiptext" id="tiptext"> Tooltip text</span>
				</div>
			</div>
	
			<div id="bodyDisplayPort" class="bodyDisplayPortCollapse">
				<div style="position:absolute;width:100%;">
					<div class="titleContainer">
						<p class="titleText"><strong>Body</strong></p>
					</div>
					<input class="screenButton" id="bodyScreenButton" type="button" onclick="expandCollapse(this, 'bodyDisplayPort')" value="Expand"></input>
					<div  id="bodyGui">
					</div>
				</div>
				<div id="bodyDisplayArea" style="height:100%;">	
				</div>
			</div>		
		
			<div id="organsDisplayPort" class="organsDisplayPortCollapse">
				<div style="position:absolute;width:100%;">
					<div class="titleContainer">
						<p class="titleText" id="OrganTitle"><strong>Organ</strong></p>
					</div>
					<input class="screenButton" id="organsScreenButton" type="button" onclick="expandCollapse(this, 'organsDisplayPort')" value="Expand"</input>
					<div  id="organGui">
					</div>			
				</div>
				<div id="organsDisplayArea" style="height:100%;">
				</div>

			</div>
			
			<div id="tissueDisplayPort" class="tissueDisplayPortCollapse">
				<div style="position:absolute;width:100%;">
					<div class="titleContainer" style="bottom:2%;">
						<p class="titleText" id="TissueTitle"><strong>Tissue</strong></p>
					</div>
					<input class="screenButton" id="tissueScreenButton" type="button" onclick="expandCollapse(this, 'tissueDisplayPort')" value="Expand"</input>
					<div id="tissueGui">
					</div>
				</div>
				<div id="tissueDisplayArea" style="height:100%;">
				</div>
				<div id="cellButtonContainer">
					<div style="padding-left:10%;float:left;text-align: center;">
					<input class="cellSelectionButton" id="cellButton1" type="button" onclick="openCellModelUI('Cardiomyocyte')" value="Cardiomyocyte"</input>
					</div>
					<div style="padding-right:10%;float:right"text-align: center;">
					<input class="cellSelectionButton" id="cellButton2" type="button" onclick="openCellModelUI('Cardiac fibroblast')" value="Cardiac fibroblast"</input>
					</div>
				</div>
			</div>
			
			<div id="cellDisplayPort" class="cellDisplayPortCollapse">
				<div style="width:100%;">
					<div class="titleContainer" style="bottom:5%;">
						<p class="titleText" id="CellTitle"><strong>Cell</strong></p>
					</div>
					<input class="screenButton" id="cellScreenButton" type="button" onclick="expandCollapse(this, 'cellDisplayPort')" value="Expand"</input>
					<div id="cellGui">
					</div>
					<div class="textContainer">
						<p style="text-align: center;">&nbsp;</p>
						<p style="text-align: center;">&nbsp;</p>
						<p style="text-align: center;">&nbsp;</p>
					</div>
				</div>
				<div id="imageContainer" style="text-align:center;bottom:4%;width:85%;left:7.5%; visibility: hidden;position: relative;">
					<a target="_blank" href = "https://models.physiomeproject.org/exposure/d5d6bff87af2bc1e94b6e8706227ba1a">
						<img align="middle" src="images/sample-heatmap.png" style="max-height:80%;max-width:100%;">
					</a>
				</div>
			</div>
			
			<div id="modelDisplayPort" class="modelDisplayPortCollapse">
				<div style="width:100%;">
					<div class="titleContainer">
						<p class="titleText" id="ModelTitle"><strong>Models</strong></p>
					</div>
					<input class="screenButton" id="modelScreenButton" type="button" onclick="expandSVGCollapse(this, 'modelDisplayPort')" value="Expand"</input>
					<div id="modelGui">
					</div>
					<div class="textContainer">
						<p style="text-align: center;">&nbsp;</p>
						<p style="text-align: center;">&nbsp;</p>
					</div>
				</div>

				<div id="modelsContainer" style="text-align:center;width:80%;height:100%;left:10%;bottom:1%; visibility: hidden;position: relative;">
					<input class="modelButton" type="button" onclick="runModel(this, 'opencor://openFile/https://models.cellml.org/workspace/noble_1962/rawfile/c70f8962407db00673f1fdcac9f35a2593781c17/noble_1962.sedml')" value="Run Simulation"></input>
					<p style="text-align: center;">&nbsp;</p>
					<p style="text-align: center;">&nbsp;</p>
					<object class="svgContainer" id="testsvg" align="middle" type="image/svg+xml">SVGs not loaded yet.</object>
				<!--
					<p style="text-align: center;">&nbsp;</p>
					<input class="modelButton" type="button" onclick="svgElemenToggle('testsvg', 'cls-5')" value="Green"></input>
					<input class="modelButton" type="button" onclick="svgElemenToggle('testsvg', 'cls-6')" value="Orange"></input>
					<input class="modelButton" type="button" onclick="svgElemenToggle('testsvg', 'cls-7')" value="Pink"></input>					

					<div style="height:20%;border-top: 2px solid #000000;">
						<div style="height:100%;left:0%;width:50%;float:left;border-right: 2px solid #000000;border-bottom: 2px solid #000000;">
							<p style="text-align: center;">Electrophysiology</p>
							<a style="padding-bottom:1%;max-width:100%;max-height:100%;" target="_blank" href = "https://models.cellml.org/exposure/5230da0/jafri_rice_winslow_1998_b.cellml/view">
								<img align="middle" src="images/jafri_rice_winslow_1998.png" class="model">
							</a>
							<input class="modelButton" type="button" onclick="runModel(this, 'opencor://openFile/https://models.cellml.org/workspace/noble_1962/rawfile/c70f8962407db00673f1fdcac9f35a2593781c17/noble_1962.sedml')" value="Run Simulation"></input>
						</div>
						<div style="height:100%;left:50%;width:50%;float:left;">
							<p style="text-align: center;">&nbsp;</p>
							<p style="text-align: center;">Metabolism</p>
							<a style="max-width:100%;max-height:100%;" target="_blank" href = "https://models.cellml.org/exposure/1a1ce68/salem_saidel_stanley_cabrera_2002.cellml/view">
								<img align="middle" src="images/salem_2002.png" class="model">
							</a>
						</div>
					</div>
					<div style="height:20%;">
						<div style="height:100%;left:0%;width:50%;float:left;border-right: 2px solid #000000;border-bottom: 2px solid #000000;">
							<p style="text-align: center;">Signalling</p>
							<a style="width:100%;" target="_blank" href = "https://models.cellml.org/exposure/39fee05/cooling_hunter_crampin_2007.cellml/view">
								<img align="middle" src="images/cooling_2007.png" class="model">
							</a>
						</div>
					</div>
					-->	
				</div>
			</div>
		</div>

		<script src="js/three.min.js"></script>
		<script src="js/OBJLoader.js"></script>
		<script src="js/STLLoader.js"></script>
		<script src="js/zinc_threejs_control.js"></script>
		<script src="js/zinc_3js_renderer.js"></script>
		<script src="js/dat.gui.js"></script>
		<script src="js/dat.gui.removeFolder.js"></script>
		<link rel="stylesheet" type="text/css" href="styles/dat-gui-swec.css">
		<script src="js/modelsLoader.js"></script>
		<script src="js/bodyRenderer.js"></script>
		<script src="js/organsRenderer.js"></script>
		<script src="js/volume_render_split3.js"></script>
		<script src="js/cell_panel.js"></script>
		<script src="js/model_panel.js"></script>
		<script src="js/svgController.js"></script>
		<script id="fragmentShaderFirstPass" type="x-shader/x-fragment">
			varying vec3 worldSpaceCoords;
			
			void main()
			{	
				//The fragment's world space coordinates as fragment output.
				gl_FragColor = vec4( worldSpaceCoords.x , worldSpaceCoords.y, worldSpaceCoords.z, 1 );
			}
		</script>
		<script id="vertexShaderFirstPass" type="x-shader/x-vertex">
			varying vec3 worldSpaceCoords;
			uniform float min_x;
			uniform float max_x;
			uniform float min_y;
			uniform float max_y;
			uniform float min_z;
			uniform float max_z;
			
			void main()
			{
				worldSpaceCoords = position + vec3(0.5, 0.5, 0.5); //move it from [-0.5;0.5] to [0,1]
				if (worldSpaceCoords.x > max_x)
				{
					worldSpaceCoords.x = max_x;
				}
				if (worldSpaceCoords.x < min_x)
				{
					worldSpaceCoords.x = min_x;
				}
				
				if (worldSpaceCoords.y > max_y)
				{
					worldSpaceCoords.y = max_y;
				}
				if (worldSpaceCoords.y < min_y)				
				{
					worldSpaceCoords.y = min_y;
				}
				
				if (worldSpaceCoords.z > max_z)
				{
					worldSpaceCoords.z = max_z;
				}
				if (worldSpaceCoords.z < min_z)
				{
					worldSpaceCoords.z = min_z;
				}		
						
				//Set the world space coordinates of the back faces vertices as output.
				
				gl_Position = projectionMatrix * modelViewMatrix * vec4( (worldSpaceCoords - vec3(0.5, 0.5, 0.5)), 1.0 );
			}
		</script>
		<script id="fragmentShaderSecondPass" type="x-shader/x-fragment">
			varying vec3 worldSpaceCoords;
			varying vec4 projectedCoords;
			uniform sampler2D tex, cubeTex;
			uniform float steps;
			uniform float alphaCorrection;
			uniform bool black_flip;
			// The maximum distance through our rendering volume is sqrt(3).
			// The maximum number of steps we take to travel a distance of 1 is 512.
			// ceil( sqrt(3) * 512 ) = 887
			// This prevents the back of the image from getting cut off when steps=512 & viewing diagonally.
			const int MAX_STEPS = 887;
			
			//Acts like a texture3D using Z slices and trilinear filtering.
			vec4 sampleAs3DTexture( vec3 texCoord )
			{
				vec4 colorSlice1, colorSlice2;
				vec2 texCoordSlice1, texCoordSlice2;

				//The z coordinate determines which Z slice we have to look for.
				//Z slice number goes from 0 to 255.
				float zSliceNumber1 = floor(texCoord.z  * 255.0);

				//As we use trilinear we go the next Z slice.
				float zSliceNumber2 = min( zSliceNumber1 + 1.0, 255.0); //Clamp to 255

				//The Z slices are stored in a matrix of 16x16 of Z slices.
				//The original UV coordinates have to be rescaled by the tile numbers in each row and column.
				texCoord.xy /= 16.0;

				texCoordSlice1 = texCoordSlice2 = texCoord.xy;

				//Add an offset to the original UV coordinates depending on the row and column number.
				texCoordSlice1.x += (mod(zSliceNumber1, 16.0 ) / 16.0);
				texCoordSlice1.y += floor((255.0 - zSliceNumber1) / 16.0) / 16.0;

				texCoordSlice2.x += (mod(zSliceNumber2, 16.0 ) / 16.0);
				texCoordSlice2.y += floor((255.0 - zSliceNumber2) / 16.0) / 16.0;

				colorSlice1 = texture2D( cubeTex, texCoordSlice1 );
				colorSlice2 = texture2D( cubeTex, texCoordSlice2 );
				colorSlice1.a = (colorSlice1.r + colorSlice1.g + colorSlice1.b) / 3.0;
				colorSlice2.a = (colorSlice2.r + colorSlice2.g + colorSlice2.b) / 3.0;

				//How distant is zSlice1 to ZSlice2. Used to interpolate between one Z slice and the other.
				float zDifference = mod(texCoord.z * 255.0, 1.0);

				//Finally interpolate between the two intermediate colors of each Z slice.
				return mix(colorSlice1, colorSlice2, zDifference) ;
			}


			void main( void ) {
				

				//Transform the coordinates it from [-1;1] to [0;1]
				vec2 texc = vec2(((projectedCoords.x / projectedCoords.w) + 1.0 ) / 2.0,
								((projectedCoords.y / projectedCoords.w) + 1.0 ) / 2.0 );

				//The back position is the world space position stored in the texture.
				vec3 backPos = texture2D(tex, texc).xyz;

				//The front position is the world space position of the second render pass.
				vec3 frontPos = worldSpaceCoords;

				//The direction from the front position to back position.
				vec3 dir = backPos - frontPos;

				float rayLength = length(dir);

				//Calculate how long to increment in each step.
				float delta = 1.0 / steps;

				//The increment in each direction for each step.
				vec3 deltaDirection = normalize(dir) * delta;
				float deltaDirectionLength = length(deltaDirection);

				//Start the ray casting from the front position.
				vec3 currentPosition = frontPos;

				//The color accumulator.
				vec4 accumulatedColor = vec4(0.0);

				//The alpha value accumulated so far.
				float accumulatedAlpha = 0.0;

				//How long has the ray travelled so far.
				float accumulatedLength = 0.0;

				//If we have twice as many samples, we only need ~1/2 the alpha per sample.
				//Scaling by 256/10 just happens to give resumeSplitDisplaya good value for the alphaCorrection slider.
				float alphaScaleFactor = 25.6 * delta;

				vec4 colorSample;
				float alphaSample;

				//Perform the ray marching iterations
				for(int i = 0; i < MAX_STEPS; i++)
				{
					//Get the voxel intensity value from the 3D texture.
					colorSample = sampleAs3DTexture( currentPosition );

					//Allow the alpha correction customization.
					alphaSample = colorSample.a * alphaCorrection;

					//Applying this effect to both the color and alpha accumulation results in more realistic transparency.
					alphaSample *= (1.0 - accumulatedAlpha);

					//Scaling alpha by the number of steps makes the final color invariant to the step size.
					alphaSample *= alphaScaleFactor;

					//Perform the composition.
					accumulatedColor += colorSample * alphaSample;

					//Store the alpha accumulated so far.
					accumulatedAlpha += alphaSample;

					//Advance the ray.
					currentPosition += deltaDirection;
					accumulatedLength += deltaDirectionLength;

					//If the length traversed is more than the ray length, or if the alpha accumulated reaches 1.0 then exit.
					if(accumulatedLength >= rayLength || accumulatedAlpha >= 1.0 )
						break;
				}

				gl_FragColor  = accumulatedColor;
				gl_FragColor.a = 1.0;
				if (black_flip)
				{
					if (gl_FragColor.r < 0.05) 
					{
						if (gl_FragColor.g < 0.05) 
						{
							if (gl_FragColor.b < 0.05) 
							{
								gl_FragColor.r = 1.0;
								gl_FragColor.g = 1.0;
								gl_FragColor.b = 1.0;
								gl_FragColor.a = 0.0;
							}
						}
					}
				}
			}
		</script>

		<script id="vertexShaderSecondPass" type="x-shader/x-vertex">
			varying vec3 worldSpaceCoords;
			varying vec4 projectedCoords;
			uniform float min_x;
			uniform float max_x;
			uniform float min_y;
			uniform float max_y;
			uniform float min_z;
			uniform float max_z;
			
			void main()
			{
				vec3 originalCoords = position + vec3(0.5, 0.5,0.5);
				if (originalCoords.x > max_x)
				{
					originalCoords.x = max_x;
				}
				if (originalCoords.x < min_x)
				{
					originalCoords.x = min_x;
				}
				if (originalCoords.y > max_y)
				{
					originalCoords.y = max_y;
				}
				if (originalCoords.y < min_y)				
				{
					originalCoords.y = min_y;
				}	
				if (originalCoords.z > max_z)
				{
					originalCoords.z = max_z;
				}
				if (originalCoords.z < min_z)
				{
					originalCoords.z = min_z;
				}		

				worldSpaceCoords = (modelMatrix * vec4(originalCoords, 1.0 )).xyz;
				gl_Position = projectionMatrix *  modelViewMatrix * vec4((originalCoords - vec3(0.5, 0.5, 0.5)), 1.0 );
				projectedCoords =  projectionMatrix * modelViewMatrix * vec4((originalCoords - vec3(0.5, 0.5, 0.5)), 1.0 );
			}
		</script>
		
		
		<script>
			var bodyRenderer = undefined;
			var zincRenderer = undefined;
			var referenceRenderer = undefined;
			var currentHoverId = -1;
			var tooltipcontainerElement = document.getElementById('tooltipcontainer');
			var tipElement = document.getElementById('tip');
			var tiptextElement = document.getElementById('tiptext');
			
			var toggleSplitDisplay = function(displayStyle) {
				var portArrays = ["bodyDisplayPort", "organsDisplayPort", "tissueDisplayPort", "cellDisplayPort", "modelDisplayPort"];
				for (var i = 0; i < portArrays.length; i++) {
					var portElement = document.getElementById(portArrays[i]);
					portElement.className = portArrays[i] + "Collapse";
					portElement.style.display = displayStyle;
				}cellDisplayPort
			}
			
			var expandCollapse = function(source, portName) {
				if (source.value=="Expand") {
					source.value = "Collapse";
					toggleSplitDisplay("none");
					var portElement = document.getElementById(portName);
					portElement.className = "fullPortDisplay";
					portElement.style.display = "block";
				}
    			else { 
    				source.value = "Expand";
    				toggleSplitDisplay("block");
    			}
			
			}
			
			function setupRenderer(elementID) {
				var localContainer = document.createElement( 'div' );
				document.getElementById(elementID).appendChild( localContainer );
				localContainer.style.height = "100%"
				var localRenderer = new Zinc.Renderer(localContainer, window);
				Zinc.defaultMaterialColor = 0xFFFF9C
				localRenderer.initialiseVisualisation();
				localRenderer.playAnimation = false;	
				return localRenderer;
			}
			

			
			bodyRenderer = setupRenderer("bodyDisplayArea");
			initialiseBodyPanel();
			//loadBody();
			
			zincRenderer = setupRenderer("organsDisplayArea");
			initialiseOrgansVisualisation();
			
			bodyRenderer.animate();
			
			zincRenderer.addPreRenderCallbackFunction(updateTimeSlider());
			zincRenderer.animate();
			
			volumeRenderInit();
			volumeRenderAnimate();
			
			initialiseCellPanel();
			initialiseModelPanel();
			
			initialiseLoading();

		</script>

	</body>
</html>
