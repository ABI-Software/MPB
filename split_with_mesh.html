<!DOCTYPE html>
<html lang="en" style="height:100%">
	<head>
		<title>Myocardium WebGL Demo</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>			
			body {
				font-family: Monospace;
				background-color: #000;
				color: #fff;
				margin: 0px;
				overflow: hidden;
			}
			#info {
				color: #fff;
				position: absolute;
				top: 10px;
				width: 100%;
				text-align: center;
				z-index: 100;
				display:block;
			}
			#info a, .button { color: #f00; font-weight: bold; text-decoration: underline; cursor: pointer }
		</style>
		<link rel="stylesheet" href="styles/my_styles.css">
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	</head>

	<body style="height:100%;">
		<div style="position:absolute;height:100%;width:100%">
			<div id="displayPort" style="position:absolute;height:100%;width:50%;left:0%;border-right: 1px solid #000000;">
				<div class="row">
					<div class="col-sm-3">
					</div>
					<div class="col-sm-1">
						<div id="playToggle" class="play" onclick="triggerAnimation()"></div>
					</div>	
					<div class="col-sm-4">
					<input id="mySlider" type="range" min="0" max="100" value ="0" step="1" oninput="sliderChanged(this.value)" style="height: 64px;width:100%;"/>
					</div>
					<div class="col-sm-4">
					</div>
				</div>
				
				
				<!-- Rounded switch -->
				
				<label class="switch">
				  <div class ="switch_text"> Heart </div>
				  <input type="checkbox" checked onclick='toggleModelDisplay(this);' value="heart">
				  <span class="slider round"></span>
				</label>
				
				<label class="switch">
				  <div class ="switch_text"> Ventricles </div>
				  <input type="checkbox" checked onclick='toggleModelDisplay(this);' value="ventricles">
				  <span class="slider round"></span>
				</label>
				
				<label class="switch">
				  <div class ="switch_text"> Nerves </div>
				  <input type="checkbox" checked onclick='toggleModelDisplay(this);' value="nerves">
				  <span class="slider round"></span>
				</label>
				
				
				<label class="switch">
				  <div class ="switch_text"> Points </div>
				  <input type="checkbox" checked onclick='toggleModelDisplay(this);' value="terminal">
				  <span class="slider round"></span>
				</label>
				
				<div id="tooltipcontainer">
					<div class="tooltip" id="tip">
		  				<span class="tooltiptext" id="tiptext"> Tooltip text</span>
					</div>
				</div>
				
			</div>
			<div id="referenceDisplayPort" style="position:absolute;height:100%;width:50%;left:50%;top:0%;">
				<p style="text-align: center;">&nbsp;</p>
				<p style="text-align: center;">&nbsp;</p>
				<p style="text-align: center;" id="text_display" ><strong>You have not selected a node yet.</strong></p>
			</div>
		</div>
		

		<script src="js/three.min.js"></script>
		<script src="js/zinc_threejs_control.js"></script>
		<script src="js/zinc_3js_renderer.js"></script>
		<script>
			var currentModel = undefined;
		
			var zincRenderer = undefined;
			var referenceRenderer = undefined;
			var currentHoverId = -1;
			var tooltipcontainerElement = document.getElementById('tooltipcontainer');
			var tipElement = document.getElementById('tip');
			var tiptextElement = document.getElementById('tiptext');
			var pickerScene = undefined;
			var displayScene = undefined;
			var windowWidth, windowHeight;
			
			var referenceScene;
			var displayGlyphList = [];
			var referenceGlyphList = [];
			var highlightedReference = undefined;
			var highlightedDisplay = undefined;
			
			function setupRenderer(elementID) {
				var localContainer = document.createElement( 'div' );
				document.getElementById(elementID).appendChild( localContainer );
				localContainer.style.height = "100%"
				var localRenderer = new Zinc.Renderer(localContainer, window);
				Zinc.defaultMaterialColor = 0xFFFF9C
				localRenderer.initialiseVisualisation();
				localRenderer.playAnimation = false;	
				return localRenderer;
			}
			
			function geometryToggle(name, flag) {
				return function(zincGeometry) {
					if (zincGeometry.groupName && zincGeometry.groupName.includes(name)) {
						zincGeometry.setVisibility(flag);
					}
				}
			}
				
			function toggleModelDisplay(callbackElement) {
				console.log(callbackElement.value);
				if (callbackElement.value == "terminal") {
					displayScene.forEachGlyphset(geometryToggle(callbackElement.value, callbackElement.checked));
					pickerScene.forEachGlyphset(geometryToggle(callbackElement.value, callbackElement.checked));
				} else {
					displayScene.forEachGeometry(geometryToggle(callbackElement.value, callbackElement.checked));
				}
			}
				
			function getPos(el) {
			    for (var lx=0, ly=0;
         			el != null;
         			lx += el.offsetLeft, ly += el.offsetTop, el = el.offsetParent);
    			return {x: lx,y: ly};
			}
		
		    function sliderChanged(slideAmount) {
				pickerScene.setMorphsTime(slideAmount * 30);
				displayScene.setMorphsTime(slideAmount * 30);
    		}

			var showTooltip = function(id, x, y) {
				if (currentHoverId != id) {
					tiptextElement.innerHTML = "Node " + id;
					var pos = getPos(document.getElementById("displayPort"));
					tooltipcontainerElement.style.left = x - pos.x +"px";
					tooltipcontainerElement.style.top = (y - 20) - pos.y + "px";
					tipElement.style.visibility = "visible";
					tipElement.style.opacity = 1;
					tiptextElement.style.visibility = "visible";
					tiptextElement.style.opacity = 1;
					currentHoverId = id;

				}
			}
			
			var hideTooltip = function() {
				currentHoverId = -1;
				tipElement.style.visibility = "hidden";
				tipElement.style.opacity = 0;
				tiptextElement.style.visibility = "hidden";
				tiptextElement.style.opacity = 0;
			}
			
			var setString = function(id) {
			 	var text_display = document.getElementById('text_display');
 				text_display.innerHTML = "<strong>You have selected node number: <span style='color:#FF4444'>" + id + "</span>.</strong>";
			}
			
			var setHighlight = function(currentObject, targetObject) {
				if (currentObject) {
					currentObject.material.emissive.setHex(0x000000);
					currentObject.geometry.colorsNeedUpdate = true;
				}
				if (targetObject) {
					targetObject.material.emissive.setHex(0xff0000);
					targetObject.geometry.colorsNeedUpdate = true;
				}
			}
			
			var _pickingCallback = function() {
				return function(intersects, window_x, window_y) {
					if (intersects[0] !== undefined) {
						var id = Math.round(intersects[ 0 ].object.material.color.b * 255) ;
						showTooltip(id, window_x, window_y);
						setString(id);
						
						//setHighlight(highlightedDisplay, displayGlyphList[id].getMesh());
						setHighlight(highlightedReference, referenceGlyphList[id].getMesh());
						highlightedReference = referenceGlyphList[id].getMesh();
						
					}
				}	
			};
			
			var _hoverCallback = function() {
				return function(intersects, window_x, window_y) {
					if (intersects[0] !== undefined) {
						var id = Math.round(intersects[ 0 ].object.material.color.b * 255) ;
						showTooltip(id, window_x, window_y);
					}
					else {
						hideTooltip();
					}
				}	
			};
													

			function setupReferenceGlyphList(glyphList) {
				return function(glyph) {
					var id = Math.round(glyph.getMesh().material.color.b * 255);
					var mesh = glyph.getMesh();
					mesh.material.color = new THREE.Color(0.2, 0.4, 1);
					mesh.geometry.colorsNeedUpdate = true;
					glyphList[id] = glyph;
					console.log(id);
				}
			}
			
			function nodeReady(glyphList) {
				return function(mygeometry) {
					if (mygeometry.groupName && mygeometry.groupName.includes("terminal")) {
						console.log(mygeometry.groupName);
						mygeometry.forEachGlyph(setupReferenceGlyphList(glyphList));
					}
				}
			}
			
			function loadMain() {
				var scene = zincRenderer.getCurrentScene();
				scene.loadViewURL("animated/heart_view.json");
				scene.loadMetadataURL("animated/animated_nerve_1.json");
				displayScene=scene;
				var directionalLight = scene.directionalLight;
				directionalLight.intensity = 1.4;
				pickerScene = zincRenderer.createScene("picker_scene");
				pickerScene.loadMetadataURL("animated/picking_node_1.json");
				var zincCameraControl = scene.getZincCameraControls();
				zincCameraControl.enableRaycaster(pickerScene, _pickingCallback(), _hoverCallback());	
			}		
			
			function loadReference() {
				var scene = referenceRenderer.getCurrentScene();
				scene.loadViewURL("reference/reference_view.json");
				scene.loadMetadataURL("reference/reference_1.json",  nodeReady(referenceGlyphList));
				referenceScene=scene;
				var directionalLight = scene.directionalLight;
				directionalLight.intensity = 1.4;
			}
			
			
			var triggerAnimation = function() {
				var playElement = document.getElementById("playToggle");
					if (playElement.className == "play") {
						playElement.className = "pause";
						zincRenderer.playAnimation = true;
					} else {
						playElement.className = "play";
						zincRenderer.playAnimation = false;
					}
			}

			
			function resetView()
			{
				zincRenderer.resetView();
			}
			
			function viewAll()
			{
				zincRenderer.viewAll();
			}
			
			
			var updateTimeSlider = function() {
				return function() {
					if (zincRenderer.playAnimation == true)	{
						var currentTime = zincRenderer.getCurrentTime();
						var sliderElement = document.getElementById("mySlider");
						var sliderValue = currentTime / 30.0;
						sliderElement.value = sliderValue;
						pickerScene.setMorphsTime(currentTime);
					}
				}	
			}
			
			zincRenderer = setupRenderer("displayPort");
			loadMain();
			referenceRenderer = setupRenderer("referenceDisplayPort");
			loadReference();
			
			zincRenderer.addPreRenderCallbackFunction(updateTimeSlider());
			zincRenderer.animate();
			referenceRenderer.animate();

		</script>

	</body>
</html>
